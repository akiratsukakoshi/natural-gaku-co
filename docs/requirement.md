# Discord AI エージェント — 最終要件定義 v1.1

（2025‑04‑28 更新・長期記憶を *n8n → Supabase* パイプラインで構築する方針を反映）

---

## 0. ゴール

1. **Discord サーバー（5〜10 名）で自然に会話し、主体的に話題を振る AI ボット**を TypeScript／Node.js で実装する。  
2. **短期・長期記憶を統合**し、個別プロファイルに合わせて応答スタイルを揺らがせる。  
3. API キー・確率値・システムプロンプト等は *.env / YAML* に完全外出し。  
4. **長期記憶更新は n8n ワークフロー**で日次バッチ処理 → Supabase (pgvector) に格納。

---

## 1. 機能要件

| #  | 機能                      | 説明 |
|----|---------------------------|------|
| F‑1 | **ユーザー応答**           | 短期メモリ＋RAG 検索（Supabase）の結果を用いて返答。 |
| F‑2 | **プロファイル学習**       | 発話から興味タグ・口調を更新。`members.yaml` と同期。 |
| F‑3 | **スタイル揺らぎ**         | ジョーク 20 %・曖昧回答 10 % など確率制御。 |
| F‑4 | **介入判定**               | “盛り上がり度 × ランダム” で応答頻度を変動。 |
| F‑5 | **主体的投げかけ**         | 静かなときに長期記憶を引き合いに低頻度で質問。 |
| F‑6 | **長期記憶 ETL**           | *n8n* が①生ログ抽出 → ②LLM 要約 → ③Supabase upsert を日次実行。 |
| F‑7 | **Bot⇄Bot スイッチ**       | `config.yaml` の `ignoreBots` で ON/OFF・ループガード。 |
| F‑8 | **参加者 YAML**            | `members.yaml` を起動時ロード・新規参加は空レコード自動追記。 |
| F‑9 | **A2A 連携土台**           | `/.well-known/agent.json` 公開・将来の RPC 受け口を stub。 |

---

## 2. 非機能要件

* **シンプル構成** — 責務ごとに小さなモジュール。  
* **可視性** — n8n で ETL を GUI 管理、ボット本体は Git でレビュー。  
* **拡張性** — InitiationModule などプラグイン式。  
* **テスト** — vitest＋supabase‑js で DB モック。

---

## 3. 技術スタック

| 分類      | 採用 |
|-----------|------|
| ランタイム | Node 18 LTS、TypeScript（ESM） |
| Discord SDK | discord.js v14 |
| LLM API   | OpenAI GPT‑4o（抽象ラッパ） |
| 長期記憶 DB | Supabase **pgvector** (`chunks` テーブル) |
| ETL       | **n8n (Docker)** + DiscordChatExporter CLI |
| OR Mapper | Prisma（ユーザー／トピック用） |
| 設定管理  | dotenv, yaml |
| テスト    | vitest |
| 将来 RPC  | Google **A2A** (agent.json + REST stub) |

---

## 4. ディレクトリ構成

```text
natural-gaku-co/
 ├─ src/
 │   ├─ discord/      … Discord クライアント
 │   ├─ context/      … BotContext (短期記憶・プロファイル)
 │   ├─ memory/       … Supabase RAG I/F
 │   ├─ responder/    … ResponseModule
 │   ├─ initiator/    … InitiationModule
 │   └─ utils/
 ├─ workflows/        … n8n export JSON (versioned)
 ├─ .env              … API keys
 ├─ config.yaml       … 温度・確率・パスなど
 ├─ members.yaml      … 参加者リスト
 └─ package.json
```

---

## 5. Supabase スキーマ

```sql
-- pgvector 拡張
CREATE EXTENSION IF NOT EXISTS "vector";

-- 生ログ
CREATE TABLE discord_messages_raw (
  id         BIGINT PRIMARY KEY,
  channel_id BIGINT NOT NULL,
  author_id  BIGINT NOT NULL,
  content    TEXT,
  timestamp  TIMESTAMPTZ
);

-- 日次要約
CREATE TABLE discord_message_summaries (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  summary_date  DATE NOT NULL,
  author_id     BIGINT NOT NULL,
  topic_tags    TEXT[],
  summary_text  TEXT
);

-- RAG チャンク
CREATE TABLE chunks (
  id         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  embedding  VECTOR(1536),
  content    TEXT,
  metadata   JSONB,
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE INDEX ON chunks USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
```

---

## 6. n8n → Supabase ETL フロー

| # | ノード                | 処理内容 |
|---|-----------------------|-----------|
| 1 | **Cron**              | 03:00 JST または隔日実行 |
| 2 | **Execute Command**   | `DiscordChatExporter` で JSON 出力 |
| 3 | **SplitInBatches → OpenAI** | Map‑Reduce 要約 (200–300 字) |
| 4 | **Function**          | Embedding 作成 (`openai.embeddings.create`) |
| 5 | **HTTP Request**      | Supabase RPC `upsert_chunks` へ挿入 |
| 6 | **Error Trigger**     | Discord #logs に通知 |

---

## 7. 外部設定ファイル例

### `.env`
```env
OPENAI_API_KEY=sk-...
DISCORD_BOT_TOKEN=...
SUPABASE_URL=https://xyz.supabase.co
SUPABASE_SERVICE_ROLE=...
```

### `config.yaml`
```yaml
llm:
  model: gpt-4o
  temperature: 0.8
style:
  joke_rate: 0.2
  vague_rate: 0.1
bot:
  ignoreBots: false
initiation:
  interval_minutes: 10
  base_prob: 0.02
  silence_threshold: 5
etl:
  export_path: ./data/logs
  schedule: "0 18 * * *"   # UTC → 03:00 JST
```

---

## 8. マイルストーン

1. **Week 1** – リポジトリ雛形／Discord 受信・返信のみ動作  
2. **Week 2** – n8n ワークフロー PoC → Supabase スキーマ展開  
3. **Week 3** – ResponseModule + InitiationModule 実装・結合テスト  
4. **Week 4** – members.yaml 自動補完、agent.json 公開、軽負荷運用開始

---

> 上記が v1.1 の確定要件です。フィードバックや追加要望があればいつでも！

